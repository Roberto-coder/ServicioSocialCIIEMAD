---
import Layout from "../layouts/BaseLayout.astro";
import { publicaciones } from "../content/publicaciones.js";

// Obtener años y tipos únicos
//Debes convertirlos a número al ordenar:
const anios = [...new Set(publicaciones.map((p) => Number(p.anio)))].sort(
  (a, b) => Number(b) - Number(a)
);
const tipos = [...new Set(publicaciones.map((p) => p.tipo))];

// Ordenar publicaciones por año descendente por defecto
const publicacionesOrdenadas = [...publicaciones].sort((a, b) =>
  b.anio.localeCompare(a.anio)
);
---

<Layout>
  <section class="max-w-3xl mx-auto my-16 px-4 font-sans">
    <h1 class="text-4xl font-serif text-guinda mb-10 text-center drop-shadow">
      Publicaciones
    </h1>
    <div
      class="flex flex-col sm:flex-row gap-4 mb-8 justify-center items-center"
    >
      <label class="font-bold text-sm">
        Año:
        <select id="filtro-anio" class="ml-2 border rounded px-2 py-1">
          <option value="">Todos</option>
          {anios.map((anio) => <option value={anio}>{anio}</option>)}
        </select>
      </label>
      <label class="font-bold text-sm">
        Tipo:
        <select id="filtro-tipo" class="ml-2 border rounded px-2 py-1">
          <option value="">Todos</option>
          {tipos.map((tipo) => <option value={tipo}>{tipo}</option>)}
        </select>
      </label>
    </div>
    <ul id="lista-publicaciones" class="space-y-8">
      {
        publicacionesOrdenadas.map((pub, idx) => (
          <li
            tabindex="0"
            class="flex items-start bg-white border-l-8 rounded-xl shadow-md p-6 hover:shadow-lg transition-all duration-300 border-verde relative outline-none focus:ring-4 focus:ring-verde/30 focus:border-verde focus:shadow-2xl active:bg-blue-50"
            data-anio={pub.anio}
            data-tipo={pub.tipo}
            data-idx={idx}
          >
            <span class="mr-4 mt-1 text-verde">
              <svg
                class="w-7 h-7"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M19 21H5a2 2 0 01-2-2V7a2 2 0 012-2h4l2-2h6a2 2 0 012 2v12a2 2 0 01-2 2z"
                />
              </svg>
            </span>
            <div class="flex-1">
              <div class="flex items-center gap-3 mb-1">
                <span class="bg-verde/90 text-white text-xs font-bold px-3 py-1 rounded-full shadow">
                  {pub.tipo}
                </span>
                <span class="bg-guinda/90 text-white text-xs font-bold px-2 py-0.5 rounded shadow">
                  {pub.anio}
                </span>
              </div>
              <h2 class="text-xl font-bold text-gray-900 mb-1 leading-snug">
                {pub.titulo}
              </h2>
              <p class="text-sm text-gray-700 mb-2">{pub.autores}</p>
            </div>
            <a
              href={pub.enlace}
              class="ml-4 mt-2 bg-verde/90 text-white px-4 py-2 rounded-lg font-semibold shadow hover:bg-guinda transition-colors duration-200 self-center"
            >
              Ver
            </a>
          </li>
        ))
      }
    </ul>
    <!-- Contenedor para mostrar/ocultar el resto de publicaciones si hay muchas -->
    <div class="mt-6 text-center">
      <button
        id="pub-toggle"
        type="button"
        class="hidden px-4 py-2 bg-guinda text-white rounded shadow hover:brightness-95 focus:outline-none"
        aria-expanded="false"
      >
        Mostrar más
      </button>
    </div>
  </section>
</Layout>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const filtroAnio = document.getElementById(
      "filtro-anio"
    ) as HTMLSelectElement | null;
    const filtroTipo = document.getElementById(
      "filtro-tipo"
    ) as HTMLSelectElement | null;
    const lista = document.getElementById(
      "lista-publicaciones"
    ) as HTMLUListElement | null;
    const toggleBtn = document.getElementById(
      "pub-toggle"
    ) as HTMLButtonElement | null;
    if (!filtroAnio || !filtroTipo || !lista || !toggleBtn) return;

    // Narrow types after the null-check so the TS checker knows they're available.
    const filtroAnioEl = filtroAnio as HTMLSelectElement;
    const filtroTipoEl = filtroTipo as HTMLSelectElement;
    const listaEl = lista as HTMLUListElement;
    const toggleBtnEl = toggleBtn as HTMLButtonElement;

    const items = Array.from(listaEl.querySelectorAll("li")) as HTMLLIElement[];
    const COLLAPSE_LIMIT = 10;
    let expanded = false;

    function applyFiltersAndCollapse() {
      const anio = filtroAnioEl.value || "";
      const tipo = filtroTipoEl.value || "";
      let matchCount = 0;

      items.forEach((item) => {
        const itemAnio = item.getAttribute("data-anio") || "";
        const itemTipo = item.getAttribute("data-tipo") || "";
        const matches =
          (!anio || itemAnio === anio) && (!tipo || itemTipo === tipo);
        if (!matches) {
          item.style.display = "none";
          return;
        }
        matchCount += 1;
        // If not expanded, only show the first COLLAPSE_LIMIT matches
        if (!expanded && matchCount > COLLAPSE_LIMIT) {
          item.style.display = "none";
        } else {
          item.style.display = "";
        }
      });

      // Update toggle button visibility and label
      if (matchCount > COLLAPSE_LIMIT) {
        toggleBtnEl.classList.remove("hidden");
        toggleBtnEl.textContent = expanded
          ? "Mostrar menos"
          : `Mostrar más (${matchCount - COLLAPSE_LIMIT})`;
        toggleBtnEl.setAttribute("aria-expanded", String(expanded));
      } else {
        toggleBtnEl.classList.add("hidden");
        toggleBtnEl.setAttribute("aria-expanded", "false");
      }
    }

    // Attach listeners
    filtroAnioEl.addEventListener("change", () => {
      expanded = false;
      applyFiltersAndCollapse();
    });
    filtroTipoEl.addEventListener("change", () => {
      expanded = false;
      applyFiltersAndCollapse();
    });

    toggleBtnEl.addEventListener("click", function () {
      expanded = !expanded;
      applyFiltersAndCollapse();
      // When collapsing, scroll to the top of the list to keep context
      if (!expanded) {
        const top = listaEl.getBoundingClientRect().top + window.scrollY - 16;
        window.scrollTo({ top: top, behavior: "smooth" });
      }
    });

    // Initial apply
    applyFiltersAndCollapse();
  });
</script>
